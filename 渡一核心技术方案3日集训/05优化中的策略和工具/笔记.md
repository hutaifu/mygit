首屏优化

背景
公司的产品面向的企业用户，大部分企业用户会选择对产品进行私有化部署。
企业对产品的需求是差异化，因此公司研发了一套低代码平台方便客户对产
品进行差异化定制。
客户通过低代码平台的定制会产生js文件，这些js文件会在运行时加载。



中心服务器-----》客户A服务器  ->差异化代码和公共代码

中心服务器----》客户b服务器   ->差异化代码和公共代码


大量客户反馈首屏等待时间过长的问题，需要定制针对性的优化策略解决问题。

而要针对的优化必须要先弄清楚目前的性能热点在哪里，因此，我们将整个优化过程分为三步：
1.问题的收集与分析
2.措施的制定与实施
3.方案的部署与反馈

以上三步可反复轮询，知道问题解决。


问题的收集与分析：
猜想 ---》 收集  ---》 分析  ---》猜想 ---》....

问题发生在客户侧，客户的系统不直接暴露到公网，因此收集问题的环节就非常麻烦。

因此我们搭建了一套客户测试数据上报的流程，让客户可以安全的把性能数据推送到我们的数据中心。



最终，问题定位：
1.http1.1协议效率地下问题
队头阻塞
头部臃肿
2.大量的js代码重复
3.大量的js代码无差别加载
4.大量的API网络请求


措施的制定与实施
1.http1.1的优化措施，
队头阻塞问题，针对同一个域名tcp链接，必须要保证请求的有序性。
只能多开域名解决。
通过中间层得到不同域名的加载js路径。

ajax请求如果也过多，通过中间层获取域名列表，客户端动态切换请求库基地址。

头部臃肿：
由于httP1.1不支持头部压缩，借鉴了http2的头部压缩，对自定的头部进行了压缩处理。
客户端和服务器建立两张静态表，1对应get请求，2对应post请求

针对动态资源，建立动态表，客户端将动态表格信息同步到服务器动态表。


针对重复代码的优化措施：
客户侧会产生巨量的差异化js文件，每个js文件的产生逻辑非常简单：
样板文件：通过样板文件动态生成文件。

结果就是客户侧生成了大量的js文件，并且代码文件有大量的重复代码。

可以想到的方法，将生成重复的代码变成一个函数，放到公共代码里面，然后调用，但是
不好实现，无法统计所有可能重复的公共代码，并且会增加大量的无效代码在公共代码中。

因此，对重复代码的提取必须动态完成。

两个问题：
1.如何找到代码中的重复代码。
2.什么时候提取重复代码。

自动提重：
通过工具生成抽象语法树：
目标：找到两棵树连续的相同结构的结构的节点，将它们提取成函数。
大致思路：
1.计算每个节点的结构hash
2.将AST树信息入库(含有hash结果)

3.寻找库中出现的连续的hash值相同的部分


代码片段就被修改为：
```js
rp_2def("department","name");
rp_2def("task","title");
```


什么时候做？：
为保证效率，提重可以异步延时执行，也可以开启计划任务在服务器空闲时执行，也可以管理员手动执行。


3.针对无差别加载的优化措施：

过去，用户自定义产生的差异js都是在首屏全部加载的，实际上，很多js并不需要在当前页面运行。

因此，需要对这些js进行差别化加载，视口内需要先加载，不需要的延时加载。
这就需要做到两件事：
1.定义每个功能页视口内组件
2.标识每个js文件对应到哪个组件(已有功能)

defer,async,动态import,

4.针对大量的API网络请求的优化措施
进行缓存操作，加一个中间层。


项目名：真实的项目
岗位：中级，高级，架构师
项目介绍：
负责/参与项目优化方案的制定和实施

项目亮点：
针对客户反馈的首屏慢问题制定了详细的优化策略并完整的参与了优化措施的落地。

通过数据埋点收集和定位性能问题，通过本地实验室复习问题。针对问题制定了具体措施，
包括解决了http1.1的队头阻塞和头部无法压缩的问题，以及开发了自动化工具完成提重从而压缩包体积
等诸多手段。

经过优化后的代码LCP(最大内容绘制)时间降低了80%，同时提供了一套完整的工单流程。






































































